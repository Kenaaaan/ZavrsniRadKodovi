using Newtonsoft.Json;
using OfficeOpenXml;
using System.ComponentModel;
using System.Xml;


// Keep only the correct way to set the EPPlus license context:
OfficeOpenXml.ExcelPackage.LicenseContext = OfficeOpenXml.LicenseContext.NonCommercial;
try
{
    // Use verbatim string literal to fix unrecognized escape sequence errors
    var filePath = @"C:\Users\kenan\OneDrive\Desktop\stanovnistvoData.xlsx";

    Console.WriteLine("Učitavanje Excel fajla i transformacija podataka...");
    var lokacije = new List<Lokacija>();

    using (var package = new ExcelPackage(new FileInfo(filePath)))
    {
        var worksheet = package.Workbook.Worksheets[0]; // Koristi prvi worksheet
        Console.WriteLine($"Učitan worksheet: {worksheet.Name}");

        string trenutnaLokacija = null;
        Lokacija aktivnaLokacija = null;
        int brojRedova = worksheet.Dimension.End.Row;
        Console.WriteLine($"Pronađeno {brojRedova} redova u Excel fajlu.");

        // Analiza headerova za debug
        Console.WriteLine("Analiza headerova tabele:");
        for (int col = 1; col <= 20; col++) // Prvi 20 kolona
        {
            Console.WriteLine($"Kolona {col}: '{worksheet.Cells[6, col].Text}'");
        }

        for (int row = 7; row <= brojRedova; row++)
        {
            // Provera da li je red prazan
            if (string.IsNullOrWhiteSpace(worksheet.Cells[row, 2].Text) && 
                string.IsNullOrWhiteSpace(worksheet.Cells[row, 3].Text) && 
                string.IsNullOrWhiteSpace(worksheet.Cells[row, 4].Text))
            {
                continue; // Preskoči prazne redove
            }

            string lokacija = worksheet.Cells[row, 2].Text.Trim();
            string starost = worksheet.Cells[row, 3].Text.Trim();
            string pol = worksheet.Cells[row, 4].Text.Trim();
            string ukupno = worksheet.Cells[row, 5].Text.Trim();

            // Detekcija nove lokacije (ako postoji vrijednost u koloni B i ne postoji vrijednost u koloni C)
            if (!string.IsNullOrEmpty(lokacija) && string.IsNullOrEmpty(starost))
            {
                trenutnaLokacija = lokacija;
                aktivnaLokacija = lokacije.FirstOrDefault(o => o.area == lokacija);
                if (aktivnaLokacija == null)
                {
                    aktivnaLokacija = new Lokacija { area = lokacija, ages = new List<Age>() };
                    lokacije.Add(aktivnaLokacija);
                    Console.WriteLine($"Dodata nova lokacija: {lokacija}");
                }
                continue; // Preskačemo ovaj red jer je to samo naziv lokacije
            }

            // Koristi prethodno detektovanu lokaciju ako trenutna ćelija lokacije je prazna
            if (string.IsNullOrEmpty(lokacija) && !string.IsNullOrEmpty(trenutnaLokacija))
            {
                aktivnaLokacija = lokacije.FirstOrDefault(o => o.area == trenutnaLokacija);
            }

            // Provera da li je aktivna lokacija postavljena
            if (aktivnaLokacija == null)
            {
                Console.WriteLine($"Upozorenje: Red {row} nema dodeljenu lokaciju, preskačem.");
                continue;
            }

            // Uzimamo samo redove sa "Ukupno/Total" u polju pol
            if (!string.IsNullOrEmpty(starost) && pol.Contains("Ukupno") && !string.IsNullOrEmpty(ukupno))
            {
                Console.WriteLine($"Procesiranje reda {row}: Lokacija='{trenutnaLokacija}', Starost='{starost}', Pol='{pol}', Ukupno='{ukupno}'");
                
                // Parsiranje starosti - može biti broj ili raspon (npr. "0-2")
                string starosnaOznaka = starost; // Sačuvamo originalnu vrijednost za prikaz
                int godina;
                
                if (int.TryParse(starost, out godina))
                {
                    // Starost je direktno broj - OK
                }
                else if (starost.Contains("-"))
                {
                    // Starost je raspon poput "0-2"
                    string[] starosniRaspon = starost.Split('-');
                    if (starosniRaspon.Length > 0 && int.TryParse(starosniRaspon[0], out godina))
                    {
                        // OK, koristimo prvi broj iz raspona
                    }
                    else
                    {
                        Console.WriteLine($"Upozorenje: Red {row} ima nevažeću starost: '{starost}', preskačem.");
                        continue;
                    }
                }
                else
                {
                    Console.WriteLine($"Upozorenje: Red {row} ima nevažeću starost: '{starost}', preskačem.");
                    continue;
                }

                // Provjera da li ukupno može biti konvertovano u broj
                if (!int.TryParse(ukupno, out int ukupnoVrednost))
                {
                    Console.WriteLine($"Upozorenje: Red {row} ima nevažeću ukupnu vrednost: '{ukupno}', preskačem.");
                    continue;
                }

                var ageData = new Age
                {
                    age = godina,
                    age_label = starosnaOznaka,  // Dodajemo originalnu oznaku starosti
                    total = ukupnoVrednost,
                    education = new Education
                    {
                        not_attending = ParseCellValue(worksheet.Cells[row, 6].Text),
                        preschool = ParseCellValue(worksheet.Cells[row, 7].Text),
                        primary = ParseCellValue(worksheet.Cells[row, 8].Text),
                        secondary = ParseCellValue(worksheet.Cells[row, 9].Text),
                        post_secondary = ParseCellValue(worksheet.Cells[row, 10].Text),
                        higher = ParseCellValue(worksheet.Cells[row, 11].Text),
                        basic_academic = ParseCellValue(worksheet.Cells[row, 12].Text),
                        specialist = ParseCellValue(worksheet.Cells[row, 13].Text),
                        masters = ParseCellValue(worksheet.Cells[row, 14].Text),
                        doctoral = ParseCellValue(worksheet.Cells[row, 15].Text),
                        first_cycle = ParseCellValue(worksheet.Cells[row, 16].Text),
                        second_cycle = ParseCellValue(worksheet.Cells[row, 17].Text),
                        integrated_cycle = ParseCellValue(worksheet.Cells[row, 18].Text),
                        third_cycle = ParseCellValue(worksheet.Cells[row, 19].Text)
                    }
                };

                // Ispis vrijednosti edukacije za debug
                Console.WriteLine($"  Education values: Not attending: {ageData.education.not_attending}, " +
                                 $"Preschool: {ageData.education.preschool}, " +
                                 $"Primary: {ageData.education.primary}, " +
                                 $"Secondary: {ageData.education.secondary}");

                aktivnaLokacija.ages.Add(ageData);
                Console.WriteLine($"Dodata starosna grupa {starosnaOznaka} za lokaciju {aktivnaLokacija.area}");
            }
        }
    }

    // Provjera da li ima podataka
    if (lokacije.Count == 0)
    {
        Console.WriteLine("Upozorenje: Nema pronađenih podataka za lokacije.");
    }
    else
    {
        Console.WriteLine($"Pronađeno {lokacije.Count} lokacija sa podacima.");
        foreach (var lokacija in lokacije)
        {
            Console.WriteLine($"Lokacija: {lokacija.area}, Broj starosnih grupa: {lokacija.ages.Count}");
        }

        // Serializacija u JSON
        string outputFileName = "stanovnistvo.json";
        string jsonContent = JsonConvert.SerializeObject(lokacije, Newtonsoft.Json.Formatting.Indented);
        File.WriteAllText(outputFileName, jsonContent);
        Console.WriteLine($"Podaci su uspješno sačuvani u fajl: {Path.GetFullPath(outputFileName)}");
        
        // Prikaži prvih nekoliko redova JSON-a za verifikaciju
        string jsonPreview = jsonContent.Length > 1000 ? jsonContent.Substring(0, 1000) + "..." : jsonContent;
        Console.WriteLine("Preview JSON-a:");
        Console.WriteLine(jsonPreview);
    }
}
catch (Exception ex)
{
    Console.WriteLine($"Greška: {ex.Message}");
    Console.WriteLine(ex.StackTrace);
}

Console.WriteLine("Pritisnite bilo koju tipku za izlaz...");
Console.ReadKey();

// Pomoćna metoda za parsiranje vrijednosti ćelije
int ParseCellValue(string cellValue)
{
    if (string.IsNullOrWhiteSpace(cellValue) || cellValue == "-")
        return 0;

    if (int.TryParse(cellValue, out int result))
        return result;

    return 0;
}

// --- Novi modeli prilagođeni zahtjevima ---
public class Lokacija
{
    public string area { get; set; }
    public List<Age> ages { get; set; }
}

public class Age
{
    public int age { get; set; }
    public string age_label { get; set; } // Dodajemo originalnu oznaku starosti (npr. "0-2")
    public int total { get; set; }
    public Education education { get; set; }
}

public class Education
{
    public int not_attending { get; set; }
    public int preschool { get; set; }
    public int primary { get; set; }
    public int secondary { get; set; }
    public int post_secondary { get; set; }
    public int higher { get; set; }
    public int basic_academic { get; set; }
    public int specialist { get; set; }
    public int masters { get; set; }
    public int doctoral { get; set; }
    public int first_cycle { get; set; }
    public int second_cycle { get; set; }
    public int integrated_cycle { get; set; }
    public int third_cycle { get; set; }
}