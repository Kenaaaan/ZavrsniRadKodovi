using Newtonsoft.Json;
using System.ComponentModel;
using System.Xml;
using ClosedXML.Excel;

try
{
    // Use verbatim string literal to fix unrecognized escape sequence errors
    var filePath = @"C:\Users\kenan\OneDrive\Desktop\stanovnistvoData.xlsx";

    Console.WriteLine("Učitavanje Excel fajla i transformacija podataka...");
    var lokacije = new List<Lokacija>();

    using (var workbook = new XLWorkbook(filePath))
    {
        var worksheet = workbook.Worksheet(1); // Koristi prvi worksheet
        Console.WriteLine($"Učitan worksheet: {worksheet.Name}");

        string trenutnaLokacija = null;
        Lokacija aktivnaLokacija = null;
        int brojRedova = worksheet.LastRowUsed().RowNumber();
        Console.WriteLine($"Pronađeno {brojRedova} redova u Excel fajlu.");

        // Analiza headerova za debug
        Console.WriteLine("Analiza headerova tabele:");
        for (int col = 1; col <= 20; col++) // Prvi 20 kolona
        {
            Console.WriteLine($"Kolona {col}: '{worksheet.Cell(6, col).GetString()}'");
        }

        // Detaljnija analiza ćelija za prvih nekoliko redova
        Console.WriteLine("\nDetaljna analiza ključnih redova:");
        for (int row = 7; row <= Math.Min(brojRedova, 20); row++)
        {
            var cell = worksheet.Cell(row, 2);
            string cellValue = cell.GetString();
            bool isEmpty = string.IsNullOrEmpty(cellValue);
            bool isWhiteSpace = string.IsNullOrWhiteSpace(cellValue);
            
            Console.WriteLine($"Red {row}: B='{cellValue}', IsEmpty={isEmpty}, IsWhiteSpace={isWhiteSpace}, CellType={cell.DataType}");
        }

        // Proveravamo da li ćelije imaju vrednost ili ne
        for (int row = 7; row <= brojRedova; row += 3) // Preskačemo po 3 reda prema vašoj strukturi
        {
            // Direktno dohvatanje vrednosti iz ćelija
            string lokacija = worksheet.Cell(row, 2).GetString().Trim();
            string starost = worksheet.Cell(row, 3).GetString().Trim();
            string pol = worksheet.Cell(row, 4).GetString().Trim();
            string ukupno = worksheet.Cell(row, 5).GetString().Trim();
            
            Console.WriteLine($"Red {row}: B='{lokacija}', C='{starost}', D='{pol}', E='{ukupno}'");

            // Preskačemo redove gde nema vrednosti u B koloni
            if (string.IsNullOrWhiteSpace(lokacija))
            {
                Console.WriteLine($"Red {row}: Preskočen - nema lokacije u koloni B.");
                continue;
            }

            // Ako imamo vrednost u koloni B i vrednost u koloni C, ovo je novi red sa lokacijom i podacima
            if (!string.IsNullOrWhiteSpace(lokacija) && !string.IsNullOrWhiteSpace(starost))
            {
                // Kreiranje nove lokacije za svaki red koji ima vrednost u B koloni
                trenutnaLokacija = lokacija;
                aktivnaLokacija = new Lokacija { area = lokacija, ages = new List<Age>() };
                lokacije.Add(aktivnaLokacija);
                Console.WriteLine($"Red {row}: Dodata nova lokacija: {lokacija}");
                
                // Obrada podataka iz ovog reda
                if (!string.IsNullOrWhiteSpace(starost) && pol.Contains("Ukupno") && !string.IsNullOrWhiteSpace(ukupno))
                {
                    ProcessRow(row, starost, pol, ukupno, worksheet, aktivnaLokacija);
                }
                else
                {
                    Console.WriteLine($"Red {row}: Preskočena obrada podataka - nije 'Ukupno' red ili nedostaju podaci.");
                }
            }
        }
    }

    // Provjera da li ima podataka
    if (lokacije.Count == 0)
    {
        Console.WriteLine("Upozorenje: Nema pronađenih podataka za lokacije.");
    }
    else
    {
        Console.WriteLine($"Pronađeno {lokacije.Count} lokacija sa podacima.");
        foreach (var lokacija in lokacije)
        {
            Console.WriteLine($"Lokacija: {lokacija.area}, Broj starosnih grupa: {lokacija.ages.Count}");
        }

        // Serializacija u JSON - koristi isti direktorij kao Excel file
        string desktopPath = @"C:\Users\kenan\OneDrive\Desktop";
        string outputFileName = Path.Combine(desktopPath, "stanovnistvo.json");
        string jsonContent = JsonConvert.SerializeObject(lokacije, Newtonsoft.Json.Formatting.Indented);
        File.WriteAllText(outputFileName, jsonContent);
        Console.WriteLine($"Podaci su uspješno sačuvani u fajl: {outputFileName}");
        
        // Prikaži prvih nekoliko redova JSON-a za verifikaciju
        string jsonPreview = jsonContent.Length > 1000 ? jsonContent.Substring(0, 1000) + "..." : jsonContent;
        Console.WriteLine("Preview JSON-a:");
        Console.WriteLine(jsonPreview);
    }
}
catch (Exception ex)
{
    Console.WriteLine($"Greška: {ex.Message}");
    Console.WriteLine(ex.StackTrace);
}

Console.WriteLine("Pritisnite bilo koju tipku za izlaz...");
Console.ReadKey();

// Pomoćna metoda za obradu jednog reda podataka
void ProcessRow(int row, string starost, string pol, string ukupno, IXLWorksheet worksheet, Lokacija aktivnaLokacija)
{
    Console.WriteLine($"Red {row}: Procesiranje - Lokacija='{aktivnaLokacija.area}', Starost='{starost}', Pol='{pol}', Ukupno='{ukupno}'");
    
    // Parsiranje starosti - može biti broj ili raspon (npr. "0-2")
    string starosnaOznaka = starost; // Sačuvamo originalnu vrijednost za prikaz
    int godina;
    
    if (int.TryParse(starost, out godina))
    {
        // Starost je direktno broj - OK
    }
    else if (starost.Contains("-"))
    {
        // Starost je raspon poput "0-2"
        string[] starosniRaspon = starost.Split('-');
        if (starosniRaspon.Length > 0 && int.TryParse(starosniRaspon[0], out godina))
        {
            // OK, koristimo prvi broj iz raspona
        }
        else
        {
            Console.WriteLine($"Red {row}: Upozorenje - nevažeća starost: '{starost}', preskačem.");
            return;
        }
    }
    else
    {
        Console.WriteLine($"Red {row}: Upozorenje - nevažeća starost: '{starost}', preskačem.");
        return;
    }

    // Provjera da li ukupno može biti konvertovano u broj
    if (!int.TryParse(ukupno, out int ukupnoVrednost))
    {
        Console.WriteLine($"Red {row}: Upozorenje - nevažeća ukupna vrednost: '{ukupno}', preskačem.");
        return;
    }

    var ageData = new Age
    {
        age = godina,
        age_label = starosnaOznaka,  // Dodajemo originalnu oznaku starosti
        total = ukupnoVrednost,
        education = new Education
        {
            not_attending = ParseCellValue(worksheet.Cell(row, 6).GetString()),
            preschool = ParseCellValue(worksheet.Cell(row, 7).GetString()),
            primary = ParseCellValue(worksheet.Cell(row, 8).GetString()),
            secondary = ParseCellValue(worksheet.Cell(row, 9).GetString()),
            post_secondary = ParseCellValue(worksheet.Cell(row, 10).GetString()),
            higher = ParseCellValue(worksheet.Cell(row, 11).GetString()),
            basic_academic = ParseCellValue(worksheet.Cell(row, 12).GetString()),
            specialist = ParseCellValue(worksheet.Cell(row, 13).GetString()),
            masters = ParseCellValue(worksheet.Cell(row, 14).GetString()),
            doctoral = ParseCellValue(worksheet.Cell(row, 15).GetString()),
            first_cycle = ParseCellValue(worksheet.Cell(row, 16).GetString()),
            second_cycle = ParseCellValue(worksheet.Cell(row, 17).GetString()),
            integrated_cycle = ParseCellValue(worksheet.Cell(row, 18).GetString()),
            third_cycle = ParseCellValue(worksheet.Cell(row, 19).GetString())
        }
    };

    // Ispis vrijednosti edukacije za debug
    Console.WriteLine($"Red {row}: Education values: Not attending: {ageData.education.not_attending}, " +
                     $"Preschool: {ageData.education.preschool}, " +
                     $"Primary: {ageData.education.primary}, " +
                     $"Secondary: {ageData.education.secondary}");

    aktivnaLokacija.ages.Add(ageData);
    Console.WriteLine($"Red {row}: Dodata starosna grupa {starosnaOznaka} za lokaciju {aktivnaLokacija.area}");
}

// Pomoćna metoda za parsiranje vrijednosti ćelije
int ParseCellValue(string cellValue)
{
    if (string.IsNullOrWhiteSpace(cellValue) || cellValue == "-")
        return 0;

    if (int.TryParse(cellValue, out int result))
        return result;

    return 0;
}

// --- Novi modeli prilagođeni zahtjevima ---
public class Lokacija
{
    public string area { get; set; }
    public List<Age> ages { get; set; }
}

public class Age
{
    public int age { get; set; }
    public string age_label { get; set; } // Dodajemo originalnu oznaku starosti (npr. "0-2")
    public int total { get; set; }
    public Education education { get; set; }
}

public class Education
{
    public int not_attending { get; set; }
    public int preschool { get; set; }
    public int primary { get; set; }
    public int secondary { get; set; }
    public int post_secondary { get; set; }
    public int higher { get; set; }
    public int basic_academic { get; set; }
    public int specialist { get; set; }
    public int masters { get; set; }
    public int doctoral { get; set; }
    public int first_cycle { get; set; }
    public int second_cycle { get; set; }
    public int integrated_cycle { get; set; }
    public int third_cycle { get; set; }
}